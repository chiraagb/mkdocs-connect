# Upload Template API

## POST `/api/v1/drafting/contract/template/upload/`

Upload a template in PDF format to the system.
The API performss:

- Organization validation
- Duplicate detection using **MD5 hash** + filename/size fallback
- Gemini processing to extract HTML with variable placeholders
- Upload to Azure Blob Storage
- Save record in MongoDB

---

## Permissions

| Requirement      | Value             |
| ---------------- | ----------------- |
| Authentication   | **Required**      |
| Permission Class | `IsAuthenticated` |

---

## Description

This endpoint allows an authenticated user to upload a contract template PDF.
The system:

1. Reads the file & computes MD5 hash
2. Checks MongoDB for duplicate templates
3. If duplicate → returns `409 CONFLICT`
4. If new → sends the file to Gemini for HTML extraction
5. Uploads the file to Azure Blob Storage
6. Saves metadata + extracted HTML in MongoDB
7. Returns template ID + HTML content + file URL

---

## Request

### **Headers**

| Key           | Value                 |
| ------------- | --------------------- |
| Authorization | `Bearer <token>`      |
| Content-Type  | `multipart/form-data` |

---

### **Form Data Fields**

| Field         | Type   | Required | Description                                         |
| ------------- | ------ | -------- | --------------------------------------------------- |
| `name`        | string | Yes      | Template name                                       |
| `type`        | string | Yes      | Template type/category                              |
| `description` | string | No       | Brief description                                   |
| `files`       | file[] | Yes      | One or more PDF files (only the first is processed) |

---

## Response (Success – 201)

```json
{
  "message": "Template uploaded, processed, saved, and uploaded to Azure successfully.",
  "template_id": "69291e28f5e5c1fd74b48165",
  "html_content": "<h1>Sales Agreement</h1> ...",
  "file_url": "https://aviaraconnectstorage.blob.core.windows.net/aviara-connect/drafting_templates/sales_contract.pdf"
}
```

---

## Response (Duplicate – 409)

```json
{
  "message": "Duplicate template detected.",
  "template_id": "69291e28f5e5c1fd74b48165",
  "file_url": "https://.../drafting_templates/sales_contract.pdf"
}
```

---

## Response (Validation Error – 400)

```json
{ "error": "No files were uploaded." }
```

OR

```json
{ "error": "User organization not found." }
```

---

## Response (Server Error – 500)

```json
{ "error": "Failed to process file with Gemini API." }
```

---

## cURL Example

```bash
curl -X POST "https://your-domain.com/api/v1/drafting/contract/template/upload/" \
  -H "Authorization: Bearer <TOKEN>" \
  -F "name=Sales Agreement" \
  -F "type=Sales/Purchase Agreement" \
  -F "description=Testing upload" \
  -F "files=@/path/to/sales_contract.pdf"
```

---

## Python Example (requests)

```python
import requests

url = "https://your-domain.com/api/v1/drafting/contract/template/upload/"
token = "<TOKEN>"

files = {
    "files": open("sales_contract.pdf", "rb")
}
data = {
    "name": "Sales Agreement",
    "type": "Sales/Purchase Agreement",
    "description": "Testing upload"
}

resp = requests.post(
    url,
    headers={"Authorization": f"Bearer {token}"},
    data=data,
    files=files
)

print(resp.status_code)
print(resp.json())
```

---

## Notes

!!! info "Important Notes"

- Only the **first file** from `files[]` is processed.
- Duplicate detection uses **MD5 hash**, then fallback to (filename + size).
- File is uploaded to **Azure Blob Storage** under `drafting_templates/<filename>`.
- The extracted HTML is generated by the Gemini API using a fixed **placeholder variable list**.
- The actual MongoDB document structure depends on your database configuration.
